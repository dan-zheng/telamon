use std::env;
use std::path::PathBuf;

fn main() {
    println!("cargo:rustc-link-lib=cudnn");

    let mut builder = bindgen::Builder::default().header("wrapper.h");

    // Get includes and libraries from CUDA_HOME if defined
    println!("cargo:rerun-if-env-changed=CUDA_HOME");
    if let Some(cuda_home) = env::var_os("CUDA_HOME").map(PathBuf::from) {
        println!(
            "cargo:rustc-link-search=native={}",
            cuda_home.join("lib64").display()
        );

        builder = builder.clang_arg(format!("-I{}", cuda_home.join("include").display()));
    }

    // grep '^cudnn' /usr/include/cudnn.h
    //  | grep -v CUDNNWINAPI
    //  | sed 's/(.*//'
    //  | sort
    //  | xargs -INAME echo '.whitelist_function("NAME")'
    let bindings = builder
        .whitelist_function("cudnnActivationBackward")
        .whitelist_function("cudnnActivationForward")
        .whitelist_function("cudnnAddTensor")
        .whitelist_function("cudnnBatchNormalizationBackward")
        .whitelist_function("cudnnBatchNormalizationBackwardEx")
        .whitelist_function("cudnnBatchNormalizationForwardInference")
        .whitelist_function("cudnnBatchNormalizationForwardTraining")
        .whitelist_function("cudnnBatchNormalizationForwardTrainingEx")
        .whitelist_function("cudnnConvolutionBackwardBias")
        .whitelist_function("cudnnConvolutionBackwardData")
        .whitelist_function("cudnnConvolutionBackwardFilter")
        .whitelist_function("cudnnConvolutionBiasActivationForward")
        .whitelist_function("cudnnConvolutionForward")
        .whitelist_function("cudnnCopyAlgorithmDescriptor")
        .whitelist_function("cudnnCreate")
        .whitelist_function("cudnnCreateActivationDescriptor")
        .whitelist_function("cudnnCreateAlgorithmDescriptor")
        .whitelist_function("cudnnCreateAlgorithmPerformance")
        .whitelist_function("cudnnCreateAttnDescriptor")
        .whitelist_function("cudnnCreateConvolutionDescriptor")
        .whitelist_function("cudnnCreateCTCLossDescriptor")
        .whitelist_function("cudnnCreateDropoutDescriptor")
        .whitelist_function("cudnnCreateFilterDescriptor")
        .whitelist_function("cudnnCreateFusedOpsConstParamPack")
        .whitelist_function("cudnnCreateFusedOpsPlan")
        .whitelist_function("cudnnCreateFusedOpsVariantParamPack")
        .whitelist_function("cudnnCreateLRNDescriptor")
        .whitelist_function("cudnnCreateOpTensorDescriptor")
        .whitelist_function("cudnnCreatePersistentRNNPlan")
        .whitelist_function("cudnnCreatePoolingDescriptor")
        .whitelist_function("cudnnCreateReduceTensorDescriptor")
        .whitelist_function("cudnnCreateRNNDataDescriptor")
        .whitelist_function("cudnnCreateRNNDescriptor")
        .whitelist_function("cudnnCreateSeqDataDescriptor")
        .whitelist_function("cudnnCreateSpatialTransformerDescriptor")
        .whitelist_function("cudnnCreateTensorDescriptor")
        .whitelist_function("cudnnCreateTensorTransformDescriptor")
        .whitelist_function("cudnnCTCLoss")
        .whitelist_function("cudnnDeriveBNTensorDescriptor")
        .whitelist_function("cudnnDestroy")
        .whitelist_function("cudnnDestroyActivationDescriptor")
        .whitelist_function("cudnnDestroyAlgorithmDescriptor")
        .whitelist_function("cudnnDestroyAlgorithmPerformance")
        .whitelist_function("cudnnDestroyAttnDescriptor")
        .whitelist_function("cudnnDestroyConvolutionDescriptor")
        .whitelist_function("cudnnDestroyCTCLossDescriptor")
        .whitelist_function("cudnnDestroyDropoutDescriptor")
        .whitelist_function("cudnnDestroyFilterDescriptor")
        .whitelist_function("cudnnDestroyFusedOpsConstParamPack")
        .whitelist_function("cudnnDestroyFusedOpsPlan")
        .whitelist_function("cudnnDestroyFusedOpsVariantParamPack")
        .whitelist_function("cudnnDestroyLRNDescriptor")
        .whitelist_function("cudnnDestroyOpTensorDescriptor")
        .whitelist_function("cudnnDestroyPersistentRNNPlan")
        .whitelist_function("cudnnDestroyPoolingDescriptor")
        .whitelist_function("cudnnDestroyReduceTensorDescriptor")
        .whitelist_function("cudnnDestroyRNNDataDescriptor")
        .whitelist_function("cudnnDestroyRNNDescriptor")
        .whitelist_function("cudnnDestroySeqDataDescriptor")
        .whitelist_function("cudnnDestroySpatialTransformerDescriptor")
        .whitelist_function("cudnnDestroyTensorDescriptor")
        .whitelist_function("cudnnDestroyTensorTransformDescriptor")
        .whitelist_function("cudnnDivisiveNormalizationBackward")
        .whitelist_function("cudnnDivisiveNormalizationForward")
        .whitelist_function("cudnnDropoutBackward")
        .whitelist_function("cudnnDropoutForward")
        .whitelist_function("cudnnDropoutGetReserveSpaceSize")
        .whitelist_function("cudnnDropoutGetStatesSize")
        .whitelist_function("cudnnFindConvolutionBackwardDataAlgorithm")
        .whitelist_function("cudnnFindConvolutionBackwardDataAlgorithmEx")
        .whitelist_function("cudnnFindConvolutionBackwardFilterAlgorithm")
        .whitelist_function("cudnnFindConvolutionBackwardFilterAlgorithmEx")
        .whitelist_function("cudnnFindConvolutionForwardAlgorithm")
        .whitelist_function("cudnnFindConvolutionForwardAlgorithmEx")
        .whitelist_function("cudnnFindRNNBackwardDataAlgorithmEx")
        .whitelist_function("cudnnFindRNNBackwardWeightsAlgorithmEx")
        .whitelist_function("cudnnFindRNNForwardInferenceAlgorithmEx")
        .whitelist_function("cudnnFindRNNForwardTrainingAlgorithmEx")
        .whitelist_function("cudnnFusedOpsExecute")
        .whitelist_function("cudnnGetActivationDescriptor")
        .whitelist_function("cudnnGetAlgorithmDescriptor")
        .whitelist_function("cudnnGetAlgorithmPerformance")
        .whitelist_function("cudnnGetAlgorithmSpaceSize")
        .whitelist_function("cudnnGetAttnDescriptor")
        .whitelist_function("cudnnGetBatchNormalizationBackwardExWorkspaceSize")
        .whitelist_function("cudnnGetBatchNormalizationForwardTrainingExWorkspaceSize")
        .whitelist_function("cudnnGetBatchNormalizationTrainingExReserveSpaceSize")
        .whitelist_function("cudnnGetCallback")
        .whitelist_function("cudnnGetConvolution2dDescriptor")
        .whitelist_function("cudnnGetConvolution2dForwardOutputDim")
        .whitelist_function("cudnnGetConvolutionBackwardDataAlgorithm")
        .whitelist_function("cudnnGetConvolutionBackwardDataAlgorithmMaxCount")
        .whitelist_function("cudnnGetConvolutionBackwardDataAlgorithm_v7")
        .whitelist_function("cudnnGetConvolutionBackwardDataWorkspaceSize")
        .whitelist_function("cudnnGetConvolutionBackwardFilterAlgorithm")
        .whitelist_function("cudnnGetConvolutionBackwardFilterAlgorithmMaxCount")
        .whitelist_function("cudnnGetConvolutionBackwardFilterAlgorithm_v7")
        .whitelist_function("cudnnGetConvolutionBackwardFilterWorkspaceSize")
        .whitelist_function("cudnnGetConvolutionForwardAlgorithm")
        .whitelist_function("cudnnGetConvolutionForwardAlgorithmMaxCount")
        .whitelist_function("cudnnGetConvolutionForwardAlgorithm_v7")
        .whitelist_function("cudnnGetConvolutionForwardWorkspaceSize")
        .whitelist_function("cudnnGetConvolutionGroupCount")
        .whitelist_function("cudnnGetConvolutionMathType")
        .whitelist_function("cudnnGetConvolutionNdDescriptor")
        .whitelist_function("cudnnGetConvolutionNdForwardOutputDim")
        .whitelist_function("cudnnGetConvolutionReorderType")
        .whitelist_function("cudnnGetCTCLossDescriptor")
        .whitelist_function("cudnnGetCTCLossDescriptorEx")
        .whitelist_function("cudnnGetCTCLossWorkspaceSize")
        .whitelist_function("cudnnGetCudartVersion")
        .whitelist_function("cudnnGetDropoutDescriptor")
        .whitelist_function("cudnnGetErrorString")
        .whitelist_function("cudnnGetFilter4dDescriptor")
        .whitelist_function("cudnnGetFilterNdDescriptor")
        .whitelist_function("cudnnGetFilterSizeInBytes")
        .whitelist_function("cudnnGetFoldedConvBackwardDataDescriptors")
        .whitelist_function("cudnnGetFusedOpsConstParamPackAttribute")
        .whitelist_function("cudnnGetFusedOpsVariantParamPackAttribute")
        .whitelist_function("cudnnGetLRNDescriptor")
        .whitelist_function("cudnnGetMultiHeadAttnBuffers")
        .whitelist_function("cudnnGetMultiHeadAttnWeights")
        .whitelist_function("cudnnGetOpTensorDescriptor")
        .whitelist_function("cudnnGetPooling2dDescriptor")
        .whitelist_function("cudnnGetPooling2dForwardOutputDim")
        .whitelist_function("cudnnGetPoolingNdDescriptor")
        .whitelist_function("cudnnGetPoolingNdForwardOutputDim")
        .whitelist_function("cudnnGetProperty")
        .whitelist_function("cudnnGetReduceTensorDescriptor")
        .whitelist_function("cudnnGetReductionIndicesSize")
        .whitelist_function("cudnnGetReductionWorkspaceSize")
        .whitelist_function("cudnnGetRNNBackwardDataAlgorithmMaxCount")
        .whitelist_function("cudnnGetRNNBackwardWeightsAlgorithmMaxCount")
        .whitelist_function("cudnnGetRNNBiasMode")
        .whitelist_function("cudnnGetRNNDataDescriptor")
        .whitelist_function("cudnnGetRNNDescriptor")
        .whitelist_function("cudnnGetRNNForwardInferenceAlgorithmMaxCount")
        .whitelist_function("cudnnGetRNNForwardTrainingAlgorithmMaxCount")
        .whitelist_function("cudnnGetRNNLinLayerBiasParams")
        .whitelist_function("cudnnGetRNNLinLayerMatrixParams")
        .whitelist_function("cudnnGetRNNMatrixMathType")
        .whitelist_function("cudnnGetRNNPaddingMode")
        .whitelist_function("cudnnGetRNNParamsSize")
        .whitelist_function("cudnnGetRNNProjectionLayers")
        .whitelist_function("cudnnGetRNNTrainingReserveSize")
        .whitelist_function("cudnnGetRNNWorkspaceSize")
        .whitelist_function("cudnnGetSeqDataDescriptor")
        .whitelist_function("cudnnGetStream")
        .whitelist_function("cudnnGetTensor4dDescriptor")
        .whitelist_function("cudnnGetTensorNdDescriptor")
        .whitelist_function("cudnnGetTensorSizeInBytes")
        .whitelist_function("cudnnGetTensorTransformDescriptor")
        .whitelist_function("cudnnGetVersion")
        .whitelist_function("cudnnIm2Col")
        .whitelist_function("cudnnInitTransformDest")
        .whitelist_function("cudnnLRNCrossChannelBackward")
        .whitelist_function("cudnnLRNCrossChannelForward")
        .whitelist_function("cudnnMakeFusedOpsPlan")
        .whitelist_function("cudnnMultiHeadAttnBackwardData")
        .whitelist_function("cudnnMultiHeadAttnBackwardWeights")
        .whitelist_function("cudnnMultiHeadAttnForward")
        .whitelist_function("cudnnOpTensor")
        .whitelist_function("cudnnPoolingBackward")
        .whitelist_function("cudnnPoolingForward")
        .whitelist_function("cudnnQueryRuntimeError")
        .whitelist_function("cudnnReduceTensor")
        .whitelist_function("cudnnReorderFilterAndBias")
        .whitelist_function("cudnnRestoreAlgorithm")
        .whitelist_function("cudnnRestoreDropoutDescriptor")
        .whitelist_function("cudnnRNNBackwardData")
        .whitelist_function("cudnnRNNBackwardDataEx")
        .whitelist_function("cudnnRNNBackwardWeights")
        .whitelist_function("cudnnRNNBackwardWeightsEx")
        .whitelist_function("cudnnRNNForwardInference")
        .whitelist_function("cudnnRNNForwardInferenceEx")
        .whitelist_function("cudnnRNNForwardTraining")
        .whitelist_function("cudnnRNNForwardTrainingEx")
        .whitelist_function("cudnnRNNGetClip")
        .whitelist_function("cudnnRNNSetClip")
        .whitelist_function("cudnnSaveAlgorithm")
        .whitelist_function("cudnnScaleTensor")
        .whitelist_function("cudnnSetActivationDescriptor")
        .whitelist_function("cudnnSetAlgorithmDescriptor")
        .whitelist_function("cudnnSetAlgorithmPerformance")
        .whitelist_function("cudnnSetAttnDescriptor")
        .whitelist_function("cudnnSetCallback")
        .whitelist_function("cudnnSetConvolution2dDescriptor")
        .whitelist_function("cudnnSetConvolutionGroupCount")
        .whitelist_function("cudnnSetConvolutionMathType")
        .whitelist_function("cudnnSetConvolutionNdDescriptor")
        .whitelist_function("cudnnSetConvolutionReorderType")
        .whitelist_function("cudnnSetCTCLossDescriptor")
        .whitelist_function("cudnnSetCTCLossDescriptorEx")
        .whitelist_function("cudnnSetDropoutDescriptor")
        .whitelist_function("cudnnSetFilter4dDescriptor")
        .whitelist_function("cudnnSetFilterNdDescriptor")
        .whitelist_function("cudnnSetFusedOpsConstParamPackAttribute")
        .whitelist_function("cudnnSetFusedOpsVariantParamPackAttribute")
        .whitelist_function("cudnnSetLRNDescriptor")
        .whitelist_function("cudnnSetOpTensorDescriptor")
        .whitelist_function("cudnnSetPersistentRNNPlan")
        .whitelist_function("cudnnSetPooling2dDescriptor")
        .whitelist_function("cudnnSetPoolingNdDescriptor")
        .whitelist_function("cudnnSetReduceTensorDescriptor")
        .whitelist_function("cudnnSetRNNAlgorithmDescriptor")
        .whitelist_function("cudnnSetRNNBiasMode")
        .whitelist_function("cudnnSetRNNDataDescriptor")
        .whitelist_function("cudnnSetRNNDescriptor")
        .whitelist_function("cudnnSetRNNDescriptor_v5")
        .whitelist_function("cudnnSetRNNDescriptor_v6")
        .whitelist_function("cudnnSetRNNMatrixMathType")
        .whitelist_function("cudnnSetRNNPaddingMode")
        .whitelist_function("cudnnSetRNNProjectionLayers")
        .whitelist_function("cudnnSetSeqDataDescriptor")
        .whitelist_function("cudnnSetSpatialTransformerNdDescriptor")
        .whitelist_function("cudnnSetStream")
        .whitelist_function("cudnnSetTensor")
        .whitelist_function("cudnnSetTensor4dDescriptor")
        .whitelist_function("cudnnSetTensor4dDescriptorEx")
        .whitelist_function("cudnnSetTensorNdDescriptor")
        .whitelist_function("cudnnSetTensorNdDescriptorEx")
        .whitelist_function("cudnnSetTensorTransformDescriptor")
        .whitelist_function("cudnnSoftmaxBackward")
        .whitelist_function("cudnnSoftmaxForward")
        .whitelist_function("cudnnSpatialTfGridGeneratorBackward")
        .whitelist_function("cudnnSpatialTfGridGeneratorForward")
        .whitelist_function("cudnnSpatialTfSamplerBackward")
        .whitelist_function("cudnnSpatialTfSamplerForward")
        .whitelist_function("cudnnTransformFilter")
        .whitelist_function("cudnnTransformTensor")
        .whitelist_function("cudnnTransformTensorEx")
        .prepend_enum_name(false)
        .generate()
        .expect("Unable to generate cudnn bindings");

    let out_path = PathBuf::from(env::var("OUT_DIR").unwrap());
    bindings
        .write_to_file(out_path.join("bindings.rs"))
        .expect("Couldn't write bindings");
}
